<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://www.netvibes.com/ns/">
  <head>
    <meta name="author" content="Ramiro GÃ³mez" />
    <meta name="description" content="Display your Github repositories grouped by language." />
    <meta name="email" content="widgets@ramiro.org" />
    <meta name="screenshot" content="https://lh6.googleusercontent.com/2hBs0-WXvJdPs6lfwbMIOhl6aSJaHa1cLxvC_kYjFpc8Pc6gdq1A3SWsBRgaojENDcX3uIPay77CJIqKek32KfwEbg=s512" />
    <meta name="thumbnail" content="https://lh5.googleusercontent.com/OnpS3SIdOVsTRtSfSvXLMDOFByweYGa2EbbpoJp6dfRYBKqcVmtO2Tznvjrk7xBHlIRRSgV0CzUYU6IW4AuXPCc7gw=s512" />
    <meta name="keywords" content="programming, developer, repositories, git, coder, github" />
    <meta name="version" content="1.2" />
    <meta name="apiVersion" content="1.2" />
    <meta name="autoRefresh" content="60" />
    <meta name="debugMode" content="true" />
    <link rel="stylesheet" type="text/css" href="http://www.netvibes.com/themes/uwa/style.css" />
    <script type="text/javascript" src="http://www.netvibes.com/js/UWA/load.js.php?env=Standalone"></script>
    <title>My Github Repos</title>
    <link rel="icon" type="image/png" href="https://github.com/fluidicon.png" />

    <!-- UWA preferences -->
    <widget:preferences>
      <preference name="user" type="text" label="Github user name" defaultValue="yaph" />
      <preference name="hide_repos" type="boolean" label="Hide repos and show after click on language" defaultValue="false" />
    </widget:preferences>

    <style type="text/css">
     .hide_elt{display:none;}
     .show_elt{display:block;}
     .github-repos-lang{cursor:pointer;}
    </style>

    <script type="text/javascript">
    String.prototype.escapeHTML = function() {
        return(
        this.replace(/&/g,'&amp;')
            .replace(/\>/g,'&gt;')
            .replace(/\</g,'&lt;')
            .replace(/\"/g,'&quot;')
            .replace(/\'/g,'&#039;')
        );
    };
    var GR = {
        serviceUserRepos: 'http://github.com/api/v2/json/repos/show/',
        target: function() {
            return document.getElementById('github-repos-by-lang');
        },
        showUserRepos: function(user, hide_repos) {
            var url = GR.serviceUserRepos + user;
            UWA.Data.getJson(GR.serviceUserRepos + user, function(json) {
                var HTML = '';
                var reposByLang = {};
                var langCounts  = [];
                repos = json.repositories;
                // populate reposByLang object
                for (i in repos) {
                    var r = repos[i];
                    if ("undefined" != typeof r.language) {
                        var lang = r.language;
                        if ("undefined" == typeof reposByLang[lang])
                            reposByLang[lang] = [];
                        reposByLang[lang].push(r);
                    }
                }
                // populatelangCounts array
                for (l in reposByLang) {
                    langCounts.push({lang: l, count: reposByLang[l].length});
                }
                langCounts.sort(function(a, b) {
                    return (a.count < b.count) ? 1 : -1;
                });
                // markup repo list
                HTML = '<ul>';
                for (i in langCounts) {
                    var lang = langCounts[i].lang;
                    if ("undefined" == typeof lang) continue;
                    var count = langCounts[i].count;
                    var rbls = reposByLang[lang];
                    // sort by last push time
                    rbls.sort(function(a, b) {
                        return (a.pushed_at < b.pushed_at) ? 1 : -1;
                    });
                    HTML += '<li class="github-repos-lang" onclick="toogleRepos(this);" title="click to show or hide repos">';
                    HTML += lang.escapeHTML() + ' (' + count + ')';
                    HTML += (hide_repos) ? '<ul class="hide_elt">' : '<ul>';
                    for (i in rbls) {
                        r = rbls[i];
                        if ("undefined" != typeof r.url && "undefined" != typeof r.name) {
                            var desc = r.name;
                            if ("undefined" != typeof r.description && r.description)
                                desc = r.description;
                            HTML += '<li><a href="' + r.url.escapeHTML() 
                                + '" title="' + desc.escapeHTML() + '">'
                                + r.name.escapeHTML() + '</a></li>';
                        }
                    }
                    HTML += '</ul></li>';
                }
                HTML += '</ul>';
                GR.target().innerHTML = HTML;
            });
        }
    };
    widget.onLoad = function() {
        var user = widget.getValue('user');
        if (user) {
            // netvibes type boolean value is of type string
            var hide_repos = ("false" === widget.getValue('hide_repos') ? false : true);
            GR.showUserRepos(user, hide_repos);
        } else {
            GR.target().innerHTML = 'You must enter a user name in the Widget settings!';
        }
    }
    function toogleRepos(elt) {
        var target = elt.childNodes[1];
        target.className =  ("hide_elt" == target.className) ? "show_elt" : "hide_elt";
    }
    </script>
  </head>
  <body>
    <div id="github-repos-by-lang"></div>
  </body>
</html>
